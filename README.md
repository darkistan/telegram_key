# KeePass Telegram Bot

Telegram-бот для роботи з базою даних KeePass через Telegram.

## Функції

- 🔍 **Пошук записів** - нечутливий до регістру пошук по всіх полях
- 📁 **Пошук за групою** - пошук всіх записів в конкретній групі
- 📋 **Список всіх записів** - перегляд всіх записів з пагінацією
- 🔐 **Детальний перегляд** - показ всіх полів запису як у KeePass
- 👥 **Управління доступом** - система дозволів для користувачів
- 📱 **Зручний інтерфейс** - кнопки та пагінація
- 🔐 **2FA авторизація** - додаткова безпека через email
- 🔒 **Захист від спаму** - пін-код для запитів на доступ

## ⚠️ БЕЗПЕКА

**КРИТИЧНО ВАЖЛИВО**: Перед використанням обов'язково налаштуйте безпеку!

- 🔒 Ніколи не комітьте `config.env` в git
- 🔑 Змініть пін-код за замовчуванням
- 🛡️ Використовуйте сильні паролі
- 📊 Регулярно перевіряйте логи

## Встановлення

1. **Клонуйте репозиторій:**
   ```bash
   git clone <repository-url>
   cd keepass_bot
   ```

2. **Створіть віртуальне середовище:**
   ```bash
   python -m venv venv
   venv\Scripts\Activate.ps1  # Windows
   # або
   source venv/bin/activate    # Linux/Mac
   ```

3. **Встановіть залежності:**
   ```bash
   pip install -r requirements.txt
   ```

4. **Налаштуйте конфігурацію:**
   - Відредагуйте файл `config.env`
   - Встановіть ваші значення:
     ```env
     TELEGRAM_BOT_TOKEN=your_bot_token_here
     ADMIN_USER_ID=your_telegram_user_id
     ACCESS_PIN=1234
     KEEPASS_DB_PATH=Database.kdbx
     KEEPASS_PASSWORD=your_keepass_password
     KEEPASS_KEY_FILE=
     ```
   
   **Налаштування шляху до бази даних:**
   - `KEEPASS_DB_PATH` - шлях до файлу `.kdbx`
   - Може бути відносним: `Database.kdbx` (в поточній папці)
   - Або абсолютним: `C:\Users\Username\Documents\MyDatabase.kdbx`
   - Або в підпапці: `data\passwords.kdbx`
   
   **Налаштування пін-коду:**
   - `ACCESS_PIN` - пін-код для запитів на доступ (запобігає спаму)
   - Змініть за замовчуванням `1234` на свій унікальний пін-код
   - Розкажіть пін-код тільки тим, кому потрібен доступ

## Запуск

```bash
python bot.py
```

## Команди бота

- `/start` - перевірка доступу та початок роботи
- `/menu` - головне меню з кнопками (зручний інтерфейс)
- `/search` - пошук записів у базі KeePass (запитує введення запиту)
- `/group` - пошук записів за групою (запитує введення назви групи)
- `/list` - показати всі записи з бази KeePass
- `/admin` - панель адміністратора (тільки для адміна)
- `/reconnect` - перепідключення до бази даних (тільки для адміна)
- `/help` - довідка по командах

### Детальний опис команд

#### `/search` - Пошук записів
- Запускає інтерактивний пошук
- Шукає по всіх полях: назва, логін, URL, нотатки
- Нечутливий до регістру
- Показує результати з пагінацією

#### `/group` - Пошук за групою
- Запускає пошук за назвою групи
- Знаходить всі записи в указаній групі
- Підтримує часткове співпадіння
- Показує повний шлях групи (наприклад: `AD HTZ/DZTM`)

#### `/list` - Список всіх записів
- Показує всі записи з бази даних
- З пагінацією (по 10 записів на сторінку)
- Відображає назву та групу для кожного запису

#### `/menu` - Головне меню
- Зручний інтерфейс з кнопками
- Динамічне меню залежно від ролі користувача
- Швидкий доступ до всіх функцій
- Кнопка повернення в меню

#### `/admin` - Панель адміністратора
- Доступна тільки для адміністратора
- Управління користувачами з доступом
- Можливість видалення користувачів
- Перегляд статистики

#### `/reconnect` - Перепідключення до бази
- Доступна тільки для адміністратора
- Примусове перепідключення до KeePass бази
- Використовується при оновленні бази даних

## Структура проекту

```
keepass_bot/
├── bot.py                # Основний файл бота
├── auth.py               # Модуль авторизації
├── keepass_handler.py    # Робота з KeePass базою
├── pagination.py         # Пагінація результатів
├── logger.py             # Логування
├── config.env            # Конфігурація (змінні середовища)
├── Database.kdbx         # База даних KeePass (налаштовується в config.env)
├── requirements.txt      # Залежності Python
├── .gitignore           # Git ignore файл
└── README.md            # Документація
```

## Налаштування

### Отримання токена бота
1. Створіть бота через [@BotFather](https://t.me/BotFather)
2. Отримайте токен у форматі: `1234567890:ABCdefGHIjklMNOpqrsTUVwxyz`

### Отримання User ID
1. Напишіть [@userinfobot](https://t.me/userinfobot)
2. Скопіюйте ваш User ID

### Підготовка бази KeePass
1. Створіть або підготуйте файл `.kdbx`
2. Запам'ятайте пароль від бази
3. Якщо використовується ключовий файл, вкажіть шлях до нього

## Безпека

- Всі паролі зберігаються в зашифрованій базі KeePass
- Доступ до бота контролюється через систему дозволів
- **2FA авторизація** через email для додаткової безпеки
- **Rate limiting** запобігає brute-force атакам
- **CSRF захист** для всіх callback запитів
- **Валідація вводу** для запобігання injection атак
- Всі дії логуються для аудиту
- Паролі показуються тільки авторизованим користувачам
- Пін-код захищає від спаму в запитах на доступ

## Адміністративні функції

### Команда `/admin`
Доступна тільки для адміністратора (ID вказаний в `ADMIN_USER_ID`):

- **Перегляд користувачів** - список всіх користувачів з доступом
- **Видалення користувачів** - натисніть на користувача для видалення
- **Пагінація** - навігація по списку користувачів
- **Повідомлення** - видалений користувач отримає повідомлення
- **Статистика** - перегляд активності користувачів

### Управління доступом
1. **Користувач надсилає `/start`** - бот перевіряє доступ
2. **Якщо доступу немає** - запитує пін-код (`ACCESS_PIN`)
3. **Після введення пін-коду** - відправляється 2FA код на email адміна
4. **Користувач вводить 2FA код** - код перевіряється
5. **Після успішної 2FA** - запит надсилається адміністратору
6. **Адміністратор схвалює/відхиляє** через кнопки в повідомленні
7. **Адміністратор може видалити** користувача через `/admin`

### Система пін-кодів
- **Захист від спаму** - пін-код необхідний для запиту на доступ
- **Налаштування** - змінюється в `config.env` (`ACCESS_PIN=1234`)
- **Безпека** - розкажіть пін-код тільки тим, кому потрібен доступ

## Приклади використання

### Пошук записів
```
Користувач: /search
Бот: Введіть запит для пошуку...
Користувач: office
Бот: 🔍 Результати пошуку для "office"
     Знайдено: 22 записів
     [Кнопки з результатами]
```

### Пошук за групою
```
Користувач: /group
Бот: Введіть назву групи для пошуку записів.
     Наприклад: Email, AD HTZ, DZTM
Користувач: Email
Бот: 📁 Записи в групі 'Email'
     Знайдено: 15 записів
     [Кнопки з результатами]
```

### Перегляд запису
```
Користувач: [Натискає на кнопку з записом]
Бот: 🔑 Назва: office@company.com
     👤 Логін: admin
     🔒 Пароль: ******** (Сила: Міцний)
     🌐 URL: https://office.company.com
     📝 Нотатки: Корпоративний офіс
     📁 Група: Email
     [Кнопка "🔙 Назад до пошуку"]
```

### Запит на доступ
```
Користувач: /start
Бот: 🔐 Запит на доступ до бота
     Для запобігання спаму введіть пін-код: 1234
Користувач: 1234
Бот: ✅ Пін-код правильний!
     📧 Код відправлено на email адміна, отримайте його та введіть.
     Код дійсний протягом 60 хвилин.
Користувач: 123456
Бот: ✅ Код підтверджено! Запит на доступ відправлено адміністратору.
Адмін: [Отримує повідомлення з кнопками "✅ Разрешить" / "❌ Отклонить"]
```

## Логування

Всі дії бота записуються в файл `logs.txt`:
- **Запити на доступ** - хто і коли запитував доступ
- **Пошук записів** - що шукали користувачі
- **Пошук за групою** - які групи переглядали
- **Перегляд паролів** - які записи переглядали
- **Адміністративні дії** - схвалення/відхилення доступів
- **Помилки** - всі помилки з деталями

### Формат логів
```
[2025-09-06 23:38:11] INFO: Пошук 'office' (нечутливий до регістру): знайдено 22 записів
[2025-09-06 23:38:11] INFO: UserID: 8379064584 | Пошук: office | Результатів: 22
[2025-09-06 23:38:23] INFO: UserID: 8379064584 | Перегляд пароля: office@company.com
```

## Технічні деталі

### Залежності
- `python-telegram-bot==20.7` - Telegram Bot API
- `pykeepass==4.0.3` - робота з KeePass базами
- `python-dotenv==1.0.0` - завантаження змінних середовища

### Архітектура
- **`bot.py`** - основний файл з обробниками команд
- **`keepass_handler.py`** - робота з KeePass базою даних
- **`auth.py`** - управління доступом користувачів
- **`pagination.py`** - пагінація результатів
- **`logger.py`** - система логування
- **`rate_limiter.py`** - обмеження швидкості запитів
- **`csrf_manager.py`** - захист від CSRF атак
- **`input_validator.py`** - валідація вхідних даних
- **`email_auth.py`** - 2FA авторизація через email

### Особливості реалізації
- **Асинхронна робота** - використання `async/await`
- **Безпечне зберігання** - паролі не зберігаються в боті
- **Кешування результатів** - для швидкої навігації
- **Обробка помилок** - детальне логування помилок
- **Валідація даних** - перевірка всіх вхідних даних
- **Rate limiting** - захист від brute-force атак
- **CSRF захист** - захист callback запитів
- **2FA авторизація** - додаткова безпека через email
- **Динамічне меню** - інтерфейс адаптується до ролі користувача

## Підтримка

При виникненні проблем:
1. **Перевірте логи** в `logs.txt` - там детальна інформація про помилки
2. **Переконайтеся в налаштуваннях** - всі параметри в `config.env` мають бути правильними
3. **Перевірте доступ до бази** - файл `.kdbx` має бути доступний та пароль правильний
4. **Перевірте токен бота** - токен має бути валідним та активним
5. **Перевірте User ID** - адміністратор має правильний User ID

### Часті проблеми
- **"База даних недоступна"** - перевірте шлях до файлу `.kdbx`
- **"Невірний пін-код"** - перевірте `ACCESS_PIN` в `config.env`
- **"У вас немає доступу"** - адміністратор має схвалити доступ
- **"Помилка пошуку"** - перевірте, що база KeePass не пошкоджена

## Ліцензія

MIT License